<div class="customize-container">
  <!-- Header -->
  <div class="customize-header">
    <h2>Device Configuration</h2>
    <p class="subtitle">Configure operational parameters stored in device NVS (Non-Volatile Storage)</p>
  </div>

  <!-- Device Selector -->
  <div class="device-selector">
    <div class="selector-group">
      <label>Select Device:</label>
      <div class="device-tabs">
        <button 
          class="device-tab"
          [class.active]="selectedDeviceType() === 'coordinator'"
          (click)="selectedDeviceType.set('coordinator')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2l9 4.9V12c0 5.25-3.6 10.17-9 11.4-5.4-1.23-9-6.15-9-11.4V6.9L12 2z"/>
          </svg>
          Coordinators
        </button>
        <button 
          class="device-tab"
          [class.active]="selectedDeviceType() === 'node'"
          (click)="selectedDeviceType.set('node')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="4"/>
          </svg>
          Nodes
        </button>
      </div>
    </div>

    <!-- Coordinator List -->
    @if (selectedDeviceType() === 'coordinator') {
      <div class="device-list">
        @for (coord of coordinators(); track coord.coord_id) {
          <button 
            class="device-item"
            [class.active]="selectedDeviceId() === coord.coord_id"
            [class.online]="coord.status === 'online'"
            (click)="selectDevice('coordinator', coord.coord_id)">
            <div class="device-info">
              <span class="device-name">{{ coord.coord_id }}</span>
              <span class="device-status">{{ coord.status }}</span>
            </div>
            <div class="device-meta">
              <span class="device-mac">{{ coord.mac_address }}</span>
              @if (coord.wifi_rssi) {
                <span class="device-signal">{{ coord.wifi_rssi }} dBm</span>
              }
            </div>
          </button>
        } @empty {
          <p class="empty-state">No coordinators available</p>
        }
      </div>
    }

    <!-- Node List -->
    @if (selectedDeviceType() === 'node') {
      <div class="device-list">
        @for (node of nodes(); track node.node_id) {
          <button 
            class="device-item"
            [class.active]="selectedDeviceId() === node.node_id"
            [class.online]="node.status === 'online'"
            (click)="selectDevice('node', node.node_id)">
            <div class="device-info">
              <span class="device-name">{{ node.name || node.node_id }}</span>
              <span class="device-status">{{ node.status }}</span>
            </div>
            <div class="device-meta">
              <span class="device-mac">{{ node.mac_address }}</span>
              @if (node.battery_percent) {
                <span class="device-battery">ðŸ”‹ {{ node.battery_percent }}%</span>
              }
            </div>
          </button>
        } @empty {
          <p class="empty-state">No nodes available</p>
        }
      </div>
    }
  </div>

  <!-- Configuration Panel -->
  @if (selectedDevice()) {
    <div class="config-panel">
      
      <!-- Loading State -->
      @if (loading()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading configuration...</p>
        </div>
      }

      <!-- Error State -->
      @if (errorMessage()) {
        <div class="error-message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          {{ errorMessage() }}
        </div>
      }

      <!-- Success State -->
      @if (saveSuccess()) {
        <div class="success-message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          Configuration saved successfully!
        </div>
      }

      <!-- Coordinator Configuration -->
      @if (selectedDeviceType() === 'coordinator' && !loading()) {
        <div class="config-section">
          <h3>Coordinator Parameters (ConfigManager)</h3>
          <p class="section-description">These values are stored in NVS and control coordinator behavior</p>

          <div class="config-form">
            <div class="form-group">
              <label>Presence Debounce (ms)
                <span class="help-text">Debounce time between presence state changes</span>
              </label>
              <input 
                type="number" 
                [value]="presenceDebounceMs()"
                (input)="presenceDebounceMs.set(+$any($event.target).value)"
                min="50" 
                max="1000" 
                step="50">
              <span class="current-value">Current: {{ presenceDebounceMs() }}ms (Default: 150ms)</span>
            </div>

            <div class="form-group">
              <label>Occupancy Hold (ms)
                <span class="help-text">How long to hold occupancy state after presence lost</span>
              </label>
              <input 
                type="number" 
                [value]="occupancyHoldMs()"
                (input)="occupancyHoldMs.set(+$any($event.target).value)"
                min="1000" 
                max="30000" 
                step="1000">
              <span class="current-value">Current: {{ occupancyHoldMs() }}ms (Default: 5000ms)</span>
            </div>

            <div class="form-group">
              <label>Fade In Duration (ms)
                <span class="help-text">Light fade-in duration when presence detected</span>
              </label>
              <input 
                type="number" 
                [value]="fadeInMs()"
                (input)="fadeInMs.set(+$any($event.target).value)"
                min="0" 
                max="2000" 
                step="50">
              <span class="current-value">Current: {{ fadeInMs() }}ms (Default: 150ms)</span>
            </div>

            <div class="form-group">
              <label>Fade Out Duration (ms)
                <span class="help-text">Light fade-out duration when presence lost</span>
              </label>
              <input 
                type="number" 
                [value]="fadeOutMs()"
                (input)="fadeOutMs.set(+$any($event.target).value)"
                min="0" 
                max="5000" 
                step="100">
              <span class="current-value">Current: {{ fadeOutMs() }}ms (Default: 1000ms)</span>
            </div>

            <div class="form-group">
              <label>Pairing Window (seconds)
                <span class="help-text">Duration pairing mode stays active</span>
              </label>
              <input 
                type="number" 
                [value]="pairingWindowS()"
                (input)="pairingWindowS.set(+$any($event.target).value)"
                min="30" 
                max="300" 
                step="30">
              <span class="current-value">Current: {{ pairingWindowS() }}s (Default: 120s)</span>
            </div>
          </div>

          <!-- Hardware Status (Read-Only) -->
          <div class="status-section">
            <h4>Hardware Status (Read-Only)</h4>
            <div class="status-grid">
              <div class="status-item">
                <span class="status-label">mmWave Radar:</span>
                <span class="status-value" [class.online]="radarOnline()">
                  {{ radarEnabled() ? (radarOnline() ? 'Online' : 'Offline') : 'Disabled' }}
                </span>
              </div>
              <div class="status-item">
                <span class="status-label">Light Sensor:</span>
                <span class="status-value" [class.online]="lightSensorEnabled()">
                  {{ lightSensorEnabled() ? 'Enabled' : 'Disabled' }}
                </span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button 
              class="btn-primary" 
              (click)="saveConfig()"
              [disabled]="saving()">
              {{ saving() ? 'Saving...' : 'Save Configuration' }}
            </button>
            <button 
              class="btn-secondary" 
              (click)="resetToDefaults()"
              [disabled]="saving() || loading()">
              Reset to Defaults
            </button>
          </div>
        </div>
      }

      <!-- Node Configuration -->
      @if (selectedDeviceType() === 'node' && !loading()) {
        <div class="config-section">
          <h3>Node Parameters (ConfigManager)</h3>
          <p class="section-description">These values are stored in NVS and control node behavior</p>

          <div class="config-form">
            <div class="form-group">
              <label>PWM Frequency (Hz)
                <span class="help-text">LED PWM frequency</span>
              </label>
              <input 
                type="number" 
                [value]="pwmFreqHz()"
                (input)="pwmFreqHz.set(+$any($event.target).value)"
                min="100" 
                max="10000" 
                step="100">
              <span class="current-value">Current: {{ pwmFreqHz() }}Hz (Default: 1000Hz)</span>
            </div>

            <div class="form-group">
              <label>PWM Resolution (bits)
                <span class="help-text">PWM resolution bits (8-16)</span>
              </label>
              <input 
                type="number" 
                [value]="pwmResBits()"
                (input)="pwmResBits.set(+$any($event.target).value)"
                min="8" 
                max="16" 
                step="1">
              <span class="current-value">Current: {{ pwmResBits() }} bits (Default: 12 bits)</span>
            </div>

            <div class="form-group">
              <label>Telemetry Interval (seconds)
                <span class="help-text">How often to send telemetry</span>
              </label>
              <input 
                type="number" 
                [value]="telemetryS()"
                (input)="telemetryS.set(+$any($event.target).value)"
                min="1" 
                max="60" 
                step="1">
              <span class="current-value">Current: {{ telemetryS() }}s (Default: 5s)</span>
            </div>

            <div class="form-group">
              <label>RX Window (ms)
                <span class="help-text">ESP-NOW receive window duration</span>
              </label>
              <input 
                type="number" 
                [value]="rxWindowMs()"
                (input)="rxWindowMs.set(+$any($event.target).value)"
                min="10" 
                max="100" 
                step="5">
              <span class="current-value">Current: {{ rxWindowMs() }}ms (Default: 20ms)</span>
            </div>

            <div class="form-group">
              <label>RX Period (ms)
                <span class="help-text">ESP-NOW receive period</span>
              </label>
              <input 
                type="number" 
                [value]="rxPeriodMs()"
                (input)="rxPeriodMs.set(+$any($event.target).value)"
                min="50" 
                max="500" 
                step="10">
              <span class="current-value">Current: {{ rxPeriodMs() }}ms (Default: 100ms)</span>
            </div>

            <div class="form-group">
              <label>Derate Start Temperature (Â°C)
                <span class="help-text">Temperature to start power derating</span>
              </label>
              <input 
                type="number" 
                [value]="derateStartC()"
                (input)="derateStartC.set(+$any($event.target).value)"
                min="50" 
                max="90" 
                step="5">
              <span class="current-value">Current: {{ derateStartC() }}Â°C (Default: 70Â°C)</span>
            </div>

            <div class="form-group">
              <label>Minimum Duty Cycle (%)
                <span class="help-text">Minimum duty cycle when derating</span>
              </label>
              <input 
                type="number" 
                [value]="derateMinDutyPct()"
                (input)="derateMinDutyPct.set(+$any($event.target).value)"
                min="10" 
                max="90" 
                step="5">
              <span class="current-value">Current: {{ derateMinDutyPct() }}% (Default: 30%)</span>
            </div>

            <div class="form-group">
              <label>Command Retry Count
                <span class="help-text">Number of ESP-NOW retries</span>
              </label>
              <input 
                type="number" 
                [value]="retryCount()"
                (input)="retryCount.set(+$any($event.target).value)"
                min="1" 
                max="10" 
                step="1">
              <span class="current-value">Current: {{ retryCount() }} (Default: 3)</span>
            </div>

            <div class="form-group">
              <label>Command TTL (ms)
                <span class="help-text">Command time-to-live</span>
              </label>
              <input 
                type="number" 
                [value]="cmdTtlMs()"
                (input)="cmdTtlMs.set(+$any($event.target).value)"
                min="500" 
                max="5000" 
                step="500">
              <span class="current-value">Current: {{ cmdTtlMs() }}ms (Default: 1500ms)</span>
            </div>
          </div>

          <!-- LED Configuration -->
          <div class="led-section">
            <h4>LED Configuration (4-pixel SK6812B)</h4>
            <div class="config-form">
              <div class="form-group">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    [checked]="ledEnabled()"
                    (change)="ledEnabled.set(!ledEnabled())">
                  <span>LED Enabled</span>
                </label>
              </div>

              <div class="form-group">
                <label>Brightness (%)
                  <span class="help-text">LED brightness level</span>
                </label>
                <input 
                  type="range" 
                  [value]="ledBrightness()"
                  (input)="ledBrightness.set(+$any($event.target).value)"
                  min="0" 
                  max="100" 
                  step="5">
                <span class="current-value">{{ ledBrightness() }}%</span>
              </div>

              <div class="form-group">
                <label>Color
                  <span class="help-text">LED color (hex)</span>
                </label>
                <div class="color-input">
                  <input 
                    type="color" 
                    [value]="ledColor()"
                    (input)="ledColor.set($any($event.target).value)">
                  <input 
                    type="text" 
                    [value]="ledColor()"
                    (input)="ledColor.set($any($event.target).value)"
                    placeholder="#00FFBF">
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button 
              class="btn-primary" 
              (click)="saveConfig()"
              [disabled]="saving()">
              {{ saving() ? 'Saving...' : 'Save Configuration' }}
            </button>
            <button 
              class="btn-secondary" 
              (click)="saveLedConfig()"
              [disabled]="saving()">
              Save LED Only
            </button>
            <button 
              class="btn-secondary" 
              (click)="resetToDefaults()"
              [disabled]="saving() || loading()">
              Reset to Defaults
            </button>
          </div>
        </div>
      }

    </div>
  } @else {
    <div class="empty-selection">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4M12 8h.01"/>
      </svg>
      <p>Select a device to configure</p>
    </div>
  }

</div>
