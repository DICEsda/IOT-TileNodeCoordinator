<div class="devices-container">
  <ng-container *ngIf="!loading(); else loadingState">
    <div class="coordinator-panel card" *ngIf="coordinator(); else noCoordinator">
      <div class="coordinator-header">
        <div>
          <p class="label">Coordinator</p>
          <h3>{{ coordinator()?.coord_id || 'Unknown coordinator' }}</h3>
          <p class="site">{{ coordinator()?.site_id || 'No site assigned' }}</p>
        </div>
        <div class="coordinator-status" [class.offline]="coordinatorStatus() !== 'online'">
          <span class="status-dot"></span>
          {{ coordinatorStatus() }}
        </div>
      </div>
      <div class="coordinator-meta">
        <div>
          <span>Firmware</span>
          <strong>{{ coordinator()?.firmware_version || 'No data' }}</strong>
        </div>
        <div>
          <span>Uptime</span>
          <strong>{{ formatUptime(coordinator()?.uptime) }}</strong>
        </div>
        <div>
          <span>Heap Free</span>
          <strong>{{ (coordinator()?.heap_free ?? null) !== null ? coordinator()?.heap_free + ' KB' : 'No data' }}</strong>
        </div>
      </div>
      <div class="link-bridge" [class.offline]="coordinatorStatus() !== 'online'">
        <div class="link-line"></div>
        <span>{{ getConnectionSubtitle() }}</span>
      </div>
    </div>

    <ng-template #noCoordinator>
      <div class="empty-state card">
        <h3>No coordinator detected</h3>
        <p>Once the coordinator connects, it will appear here with its live serial link.</p>
      </div>
    </ng-template>

    <div class="devices-header card">
      <h2>Devices & Sensors</h2>
      <div class="devices-stats">
        <div class="stat">
          <span class="stat-value">{{ onlineDevicesCount }}</span>
          <span class="stat-label">Online</span>
        </div>
        <div class="stat">
          <span class="stat-value warning">{{ warningDevicesCount }}</span>
          <span class="stat-label">Warning</span>
        </div>
        <div class="stat">
          <span class="stat-value danger">{{ offlineDevicesCount }}</span>
          <span class="stat-label">Offline</span>
        </div>
      </div>
    </div>

    <div class="devices-grid" *ngIf="getNodesList().length; else noNodes">
      @for (node of getNodesList(); track node.node_id) {
        <div class="device-card card" [class]="node.status">
          <div class="device-header">
            <div class="device-info">
              <h3>{{ node.node_id || 'Unknown node' }}</h3>
              <p class="location">Zone: {{ node.zone_id || 'No data' }}</p>
            </div>
            <div class="device-status" [class]="node.status">
              <span class="status-dot"></span>
              {{ node.status || 'offline' }}
            </div>
          </div>

          <div class="device-metrics">
            <div class="metric-row">
              <div class="metric">
                <span class="metric-label">Battery</span>
                <div class="battery-indicator" [class]="getBatteryClass(getBatteryPercent(node))">
                  <div class="battery-fill" [style.width.%]="getBatteryPercent(node) ?? 0"></div>
                  <span class="battery-text">{{ getBatteryPercent(node) !== null ? (getBatteryPercent(node) + '%') : 'No data' }}</span>
                </div>
              </div>
            </div>

            <div class="metric-row">
              <div class="metric">
                <span class="metric-label">Brightness</span>
                <span class="metric-value">{{ node.brightness !== undefined ? node.brightness + '%' : 'No data' }}</span>
              </div>
            </div>

            <div class="metric-row">
              <div class="metric">
                <span class="metric-label">Last Seen</span>
                <span class="metric-value">{{ formatLastSeen(node.last_seen) }}</span>
              </div>
            </div>
          </div>

          <div class="sensors-section">
            <h4>Sensors</h4>
            <div class="sensors-grid">
              @for (sensor of getSensorRows(node); track sensor.label) {
                <div class="sensor-item" [class.missing]="!sensor.value">
                  <div class="sensor-info">
                    <span class="sensor-type">{{ sensor.label }}</span>
                    <span class="sensor-value">{{ sensor.value || 'No data' }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }
    </div>

    <ng-template #noNodes>
      <div class="empty-state card">
        <h3>No nodes reporting yet</h3>
        <p>Pair a tile node or wait for telemetry to stream in.</p>
      </div>
    </ng-template>
  </ng-container>

  <ng-template #loadingState>
    <div class="empty-state card">
      <h3>Loading devicesâ€¦</h3>
      <p>Fetching coordinator and node telemetry.</p>
    </div>
  </ng-template>
</div>

