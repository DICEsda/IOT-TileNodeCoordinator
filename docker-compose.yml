services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: iot-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-iot_smarttile}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - iot-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Mosquitto MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: iot-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./IOT-Backend-main/IOT-Backend-main/internal/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./IOT-Backend-main/IOT-Backend-main/internal/config/pwfile:/mosquitto/config/pwfile
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Go Backend API
  backend:
    build:
      context: ./IOT-Backend-main/IOT-Backend-main
      dockerfile: Dockerfile
    container_name: iot-backend
    restart: unless-stopped
    environment:
      HTTP_ADDR: ${HTTP_ADDR:-:8000}
      MQTT_BROKER: ${MQTT_BROKER:-tcp://mosquitto:1883}
      MQTT_USERNAME: ${MQTT_USERNAME:-user1}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-user1}
      MONGO_URI: ${MONGO_URI:-mongodb://admin:admin123@mongodb:27017}
      MONGO_DB: ${MONGO_DB:-iot_smarttile}
      # ESP32 Configuration
      ESP32_WIFI_SSID: ${ESP32_WIFI_SSID}
      ESP32_WIFI_PASSWORD: ${ESP32_WIFI_PASSWORD}
      # Google Home Configuration
      GOOGLE_HOME_ENABLED: ${GOOGLE_HOME_ENABLED:-false}
      GOOGLE_HOME_PROJECT_ID: ${GOOGLE_HOME_PROJECT_ID}
      GOOGLE_HOME_CLIENT_ID: ${GOOGLE_HOME_CLIENT_ID}
      GOOGLE_HOME_CLIENT_SECRET: ${GOOGLE_HOME_CLIENT_SECRET}
      GOOGLE_HOME_API_KEY: ${GOOGLE_HOME_API_KEY}
      GOOGLE_OAUTH_REDIRECT_URI: ${GOOGLE_OAUTH_REDIRECT_URI}
      GOOGLE_HOMEGRAPH_API_URL: ${GOOGLE_HOMEGRAPH_API_URL:-https://homegraph.googleapis.com/v1}
      GOOGLE_SERVICE_ACCOUNT_KEY: ${GOOGLE_SERVICE_ACCOUNT_KEY:-/app/config/google-service-account.json}
    ports:
      - "8000:8000"
    volumes:
      - ./IOT-Backend-main/IOT-Backend-main/internal/config/google-service-account.json:/app/config/google-service-account.json:ro
    depends_on:
      mongodb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Angular Frontend
  frontend:
    build:
      context: ./IOT-Frontend-main/IOT-Frontend-main
      dockerfile: Dockerfile
    container_name: iot-frontend
    restart: unless-stopped
    environment:
      API_URL: ${API_URL:-http://backend:8000}
      WS_URL: ${WS_URL:-ws://backend:8000/ws}
    ports:
      - "4200:80"
    depends_on:
      - backend
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  iot-network:
    driver: bridge

volumes:
  mongodb_data:
  mongodb_config:
  mosquitto_data:
  mosquitto_log:
