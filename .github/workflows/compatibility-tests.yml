name: Compatibility Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  browser-compatibility:
    name: Browser Compatibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: IOT-Frontend-main/IOT-Frontend-main/package-lock.json

      - name: Install dependencies
        working-directory: IOT-Frontend-main/IOT-Frontend-main
        run: npm ci

      - name: Build for production
        working-directory: IOT-Frontend-main/IOT-Frontend-main
        run: npm run build -- --configuration=production

      - name: Check build output
        working-directory: IOT-Frontend-main/IOT-Frontend-main
        run: |
          echo "Checking build artifacts..."
          ls -la dist/
          echo "✓ Production build successful"

  api-version-compatibility:
    name: API Version Compatibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API collection
        run: |
          echo "Checking API collection..."
          test -f api-collection.json && echo "✓ API collection exists"
          cat api-collection.json | python -m json.tool > /dev/null
          echo "✓ API collection is valid JSON"

      - name: Validate MQTT topics
        run: |
          echo "Checking MQTT topic documentation..."
          test -f docs/mqtt_api.md && echo "✓ MQTT API docs exist" || echo "ℹ️  MQTT docs not found"

  docker-version-compatibility:
    name: Docker Version Compatibility
    runs-on: ubuntu-latest
    strategy:
      matrix:
        docker-compose-version: ['2.20.0', '2.23.0']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Docker Compose ${{ matrix.docker-compose-version }}
        run: |
          curl -L "https://github.com/docker/compose/releases/download/v${{ matrix.docker-compose-version }}/docker-compose-$(uname -s)-$(uname -m)" -o /tmp/docker-compose
          chmod +x /tmp/docker-compose
          /tmp/docker-compose version

      - name: Validate with Docker Compose ${{ matrix.docker-compose-version }}
        run: |
          /tmp/docker-compose -f docker-compose.yml config > /dev/null
          echo "✓ Compatible with Docker Compose ${{ matrix.docker-compose-version }}"

  python-version-firmware:
    name: PlatformIO Python Compatibility
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Check PlatformIO installation
        run: |
          pio --version
          echo "✓ PlatformIO compatible with Python ${{ matrix.python-version }}"

      - name: Validate platformio.ini
        working-directory: coordinator
        run: |
          pio project config
          echo "✓ Coordinator config valid"

  mongodb-version-compatibility:
    name: MongoDB Version Compatibility
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mongodb-version: ['6.0', '7.0']
    services:
      mongodb:
        image: mongo:${{ matrix.mongodb-version }}
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test MongoDB ${{ matrix.mongodb-version }}
        run: |
          docker run --rm --network host mongo:${{ matrix.mongodb-version }} mongosh "mongodb://testuser:testpass@localhost:27017" --eval "db.version()"
          echo "✓ MongoDB ${{ matrix.mongodb-version }} compatible"

  esp32-platform-check:
    name: ESP32 Platform Compatibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Check ESP32 platforms
        run: |
          echo "Checking ESP32 platform compatibility..."
          pio platform show espressif32
          echo "✓ ESP32 platform available"

      - name: Validate coordinator config
        working-directory: coordinator
        run: |
          echo "Validating coordinator platformio.ini..."
          pio project config --json-output | python -m json.tool
          echo "✓ Coordinator configuration valid"

      - name: Validate node config
        working-directory: node
        run: |
          echo "Validating node platformio.ini..."
          pio project config --json-output | python -m json.tool
          echo "✓ Node configuration valid"

  shared-library-compatibility:
    name: Shared Library Compatibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check shared directory
        run: |
          echo "Checking shared library structure..."
          test -d shared && echo "✓ Shared directory exists"
          find shared -name "*.h" -o -name "*.cpp" | wc -l
          echo "✓ Shared library files found"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Verify coordinator can access shared
        working-directory: coordinator
        run: |
          echo "Checking coordinator shared library access..."
          pio project config | grep -i "lib_extra_dirs" || true
          echo "✓ Coordinator shared library configuration checked"

      - name: Verify node can access shared
        working-directory: node
        run: |
          echo "Checking node shared library access..."
          pio project config | grep -i "lib_extra_dirs" || true
          echo "✓ Node shared library configuration checked"
