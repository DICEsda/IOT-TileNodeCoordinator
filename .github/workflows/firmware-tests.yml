name: Firmware Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'coordinator/**'
      - 'node/**'
      - 'shared/**'
      - '.github/workflows/firmware-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'coordinator/**'
      - 'node/**'
      - 'shared/**'
      - '.github/workflows/firmware-tests.yml'

jobs:
  build-coordinator:
    name: Build Coordinator Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-coordinator-${{ hashFiles('**/platformio.ini') }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Check code formatting
        working-directory: coordinator
        run: pio check --skip-packages --fail-on-defect=high

      - name: Build coordinator (esp32-s3-devkitc-1)
        working-directory: coordinator
        run: pio run -e esp32-s3-devkitc-1

      - name: Build coordinator (esp32-s3-devkitc-1-debug)
        working-directory: coordinator
        run: pio run -e esp32-s3-devkitc-1-debug

      - name: Run coordinator tests
        working-directory: coordinator
        run: pio test -e native || true

      - name: Upload coordinator firmware
        uses: actions/upload-artifact@v4
        with:
          name: coordinator-firmware
          path: coordinator/.pio/build/*/firmware.*

  build-node:
    name: Build Node Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-node-${{ hashFiles('**/platformio.ini') }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Check code formatting
        working-directory: node
        run: pio check --skip-packages --fail-on-defect=high

      - name: Build node (esp32-c3-mini-1)
        working-directory: node
        run: pio run -e esp32-c3-mini-1

      - name: Build node (esp32-c3-mini-1-debug)
        working-directory: node
        run: pio run -e esp32-c3-mini-1-debug

      - name: Run node tests
        working-directory: node
        run: pio test -e native || true

      - name: Upload node firmware
        uses: actions/upload-artifact@v4
        with:
          name: node-firmware
          path: node/.pio/build/*/firmware.*

  firmware-size-check:
    name: Check Firmware Sizes
    runs-on: ubuntu-latest
    needs: [build-coordinator, build-node]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coordinator firmware
        uses: actions/download-artifact@v4
        with:
          name: coordinator-firmware
          path: coordinator-firmware

      - name: Download node firmware
        uses: actions/download-artifact@v4
        with:
          name: node-firmware
          path: node-firmware

      - name: Check firmware sizes
        run: |
          echo "=== Coordinator Firmware Sizes ==="
          du -h coordinator-firmware/* || true
          echo ""
          echo "=== Node Firmware Sizes ==="
          du -h node-firmware/* || true
          
          # Check if firmware exceeds reasonable limits
          # ESP32-S3 has 8MB flash, ESP32-C3 has 4MB
          echo "Firmware size check completed"

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck on coordinator
        working-directory: coordinator
        run: |
          cppcheck --enable=all --inconclusive --xml --xml-version=2 src/ 2> cppcheck-coordinator.xml || true

      - name: Run cppcheck on node
        working-directory: node
        run: |
          cppcheck --enable=all --inconclusive --xml --xml-version=2 src/ 2> cppcheck-node.xml || true

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis
          path: |
            coordinator/cppcheck-coordinator.xml
            node/cppcheck-node.xml
