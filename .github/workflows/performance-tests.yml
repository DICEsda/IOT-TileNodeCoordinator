name: Performance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-benchmarks:
    name: Backend Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run benchmarks
        working-directory: IOT-Backend-main
        run: |
          echo "Running Go benchmarks..."
          go test -bench=. -benchmem -run=^$ ./... | tee benchmark.txt || echo "No benchmarks found"
          echo "✓ Benchmark run complete"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: backend-benchmarks
          path: IOT-Backend-main/benchmark.txt
        if: always()

  build-time-tracking:
    name: Build Time Tracking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Measure backend build time
        working-directory: IOT-Backend-main
        run: |
          echo "Measuring backend build time..."
          START=$(date +%s)
          go build -v ./cmd/iot/main.go
          END=$(date +%s)
          DIFF=$((END - START))
          echo "Backend build time: ${DIFF}s"
          echo "BACKEND_BUILD_TIME=${DIFF}" >> $GITHUB_ENV

      - name: Measure frontend build time
        working-directory: IOT-Frontend-main/IOT-Frontend-main
        run: |
          echo "Measuring frontend build time..."
          npm ci
          START=$(date +%s)
          npm run build
          END=$(date +%s)
          DIFF=$((END - START))
          echo "Frontend build time: ${DIFF}s"
          echo "FRONTEND_BUILD_TIME=${DIFF}" >> $GITHUB_ENV

      - name: Report build times
        run: |
          echo "=== Build Time Report ==="
          echo "Backend: ${BACKEND_BUILD_TIME}s"
          echo "Frontend: ${FRONTEND_BUILD_TIME}s"

  firmware-size-analysis:
    name: Firmware Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build and analyze coordinator
        working-directory: coordinator
        run: |
          echo "Building coordinator firmware..."
          pio run -e esp32-s3-devkitc-1
          echo "Coordinator firmware size:"
          ls -lh .pio/build/esp32-s3-devkitc-1/firmware.bin
          SIZE=$(stat -f%z .pio/build/esp32-s3-devkitc-1/firmware.bin 2>/dev/null || stat -c%s .pio/build/esp32-s3-devkitc-1/firmware.bin)
          echo "Size: $SIZE bytes ($((SIZE / 1024)) KB)"

      - name: Build and analyze node
        working-directory: node
        run: |
          echo "Building node firmware..."
          pio run -e esp32-c3-mini-1
          echo "Node firmware size:"
          ls -lh .pio/build/esp32-c3-mini-1/firmware.bin
          SIZE=$(stat -f%z .pio/build/esp32-c3-mini-1/firmware.bin 2>/dev/null || stat -c%s .pio/build/esp32-c3-mini-1/firmware.bin)
          echo "Size: $SIZE bytes ($((SIZE / 1024)) KB)"

      - name: Check size limits
        run: |
          echo "✓ Firmware size analysis complete"
          echo "ESP32-S3 has 8MB flash"
          echo "ESP32-C3 has 4MB flash"

  dependency-size:
    name: Dependency Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Analyze frontend dependencies
        working-directory: IOT-Frontend-main/IOT-Frontend-main
        run: |
          npm ci
          echo "Frontend node_modules size:"
          du -sh node_modules
          echo "Production dependencies size:"
          npm list --prod --depth=0 | wc -l
          echo "Dev dependencies size:"
          npm list --dev --depth=0 | wc -l

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Analyze backend dependencies
        working-directory: IOT-Backend-main
        run: |
          echo "Go module dependencies:"
          go list -m all | wc -l
          echo "Direct dependencies:"
          go list -m -f '{{if not .Indirect}}{{.Path}}{{end}}' all | grep -v "^$" | wc -l

  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count lines of code
        run: |
          echo "=== Lines of Code ==="
          echo "Backend Go code:"
          find IOT-Backend-main -name "*.go" | xargs wc -l | tail -1
          echo "Frontend TypeScript code:"
          find IOT-Frontend-main -name "*.ts" -not -path "*/node_modules/*" | xargs wc -l | tail -1 || true
          echo "Coordinator firmware:"
          find coordinator/src -name "*.cpp" -o -name "*.h" | xargs wc -l | tail -1
          echo "Node firmware:"
          find node/src -name "*.cpp" -o -name "*.h" | xargs wc -l | tail -1

      - name: Count files
        run: |
          echo "=== File Counts ==="
          echo "Go files: $(find IOT-Backend-main -name "*.go" | wc -l)"
          echo "TypeScript files: $(find IOT-Frontend-main -name "*.ts" -not -path "*/node_modules/*" | wc -l)"
          echo "C++ files: $(find coordinator node -name "*.cpp" -o -name "*.h" | wc -l)"
          echo "✓ Metrics collected"
