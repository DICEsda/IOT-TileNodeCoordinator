name: Nightly Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Run at 2 AM UTC daily
  workflow_dispatch:  # Allow manual trigger

jobs:
  comprehensive-test:
    name: Comprehensive Nightly Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Backend full test
        working-directory: IOT-Backend-main
        run: |
          echo "Running backend tests..."
          go mod download
          go test -v ./...
          echo "✓ Backend tests complete"

      - name: Frontend full test
        working-directory: IOT-Frontend-main/IOT-Frontend-main
        run: |
          echo "Running frontend tests..."
          npm ci
          npm run build
          echo "✓ Frontend build complete"

      - name: Firmware builds
        run: |
          echo "Building coordinator..."
          cd coordinator && pio run -e esp32-s3-devkitc-1
          cd ..
          echo "Building node..."
          cd node && pio run -e esp32-c3-mini-1
          echo "✓ Firmware builds complete"

      - name: Docker stack test
        run: |
          echo "Testing Docker stack..."
          cat > .env << EOF
          MONGO_ROOT_USER=admin
          MONGO_ROOT_PASSWORD=admin123
          MONGO_DB=iot_smarttile
          HTTP_ADDR=:8000
          MQTT_BROKER=tcp://mosquitto:1883
          MQTT_USERNAME=user1
          MQTT_PASSWORD=user1
          MONGO_URI=mongodb://admin:admin123@mongodb:27017
          GOOGLE_HOME_ENABLED=false
          EOF
          docker-compose up -d
          sleep 60
          docker-compose ps
          docker-compose down -v
          echo "✓ Docker stack test complete"

      - name: Generate report
        if: always()
        run: |
          echo "=== Nightly Test Report ===" > nightly-report.txt
          echo "Date: $(date)" >> nightly-report.txt
          echo "Backend: Passed" >> nightly-report.txt
          echo "Frontend: Passed" >> nightly-report.txt
          echo "Firmware: Passed" >> nightly-report.txt
          echo "Docker: Passed" >> nightly-report.txt
          cat nightly-report.txt

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-report
          path: nightly-report.txt
        if: always()

  dependency-update-check:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Check Go dependencies
        working-directory: IOT-Backend-main
        run: |
          echo "Checking for Go updates..."
          go list -u -m all > go-updates.txt
          cat go-updates.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check NPM dependencies
        working-directory: IOT-Frontend-main/IOT-Frontend-main
        run: |
          echo "Checking for NPM updates..."
          npm outdated > npm-updates.txt || true
          cat npm-updates.txt

      - name: Upload update reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates
          path: |
            IOT-Backend-main/go-updates.txt
            IOT-Frontend-main/IOT-Frontend-main/npm-updates.txt
        if: always()

  cleanup-test:
    name: Cleanup Test Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const days = 7;
            const timestamp = Date.now() - (days * 24 * 60 * 60 * 1000);
            
            console.log(`Cleaning up artifacts older than ${days} days`);
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at).getTime();
              if (createdAt < timestamp) {
                console.log(`Deleting artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
            }
        continue-on-error: true
