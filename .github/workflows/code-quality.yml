name: Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: avto-dev/markdown-lint@v1
        with:
          args: '**/*.md'
          ignore: 'node_modules'
        continue-on-error: true

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -d relaxed docker-compose.yml || true
          yamllint -d relaxed .github/workflows/*.yml || true

  json-validation:
    name: JSON Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          for file in $(find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/.pio/*"); do
            echo "Validating $file"
            python -m json.tool "$file" > /dev/null || echo "Invalid JSON: $file"
          done

  file-structure:
    name: Project Structure Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking project structure..."
          test -f README.md && echo "✓ README.md exists"
          test -f docker-compose.yml && echo "✓ docker-compose.yml exists"
          test -d coordinator && echo "✓ coordinator/ exists"
          test -d node && echo "✓ node/ exists"
          test -d IOT-Backend-main && echo "✓ IOT-Backend-main/ exists"
          test -d IOT-Frontend-main && echo "✓ IOT-Frontend-main/ exists"
          test -d shared && echo "✓ shared/ exists"
          test -d docs && echo "✓ docs/ exists"
          echo "Project structure check passed!"

  line-endings:
    name: Line Endings Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check line endings
        run: |
          echo "Checking for CRLF line endings..."
          if file * | grep "CRLF"; then
            echo "⚠️  CRLF line endings found (Windows style)"
          else
            echo "✓ No CRLF issues found"
          fi
        continue-on-error: true

  trailing-whitespace:
    name: Trailing Whitespace Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check trailing whitespace
        run: |
          echo "Checking for trailing whitespace..."
          if grep -r -n -I -E '\s+$' . --exclude-dir={node_modules,.git,.pio,dist,build} --exclude="*.{min.js,min.css}" | head -20; then
            echo "⚠️  Trailing whitespace found (showing first 20)"
          else
            echo "✓ No trailing whitespace found"
          fi
        continue-on-error: true
