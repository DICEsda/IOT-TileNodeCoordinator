name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend Tests
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Install dependencies
      working-directory: ./IOT-Backend-main
      run: go mod download
    
    - name: Run tests
      working-directory: ./IOT-Backend-main
      run: go test -v ./...
    
    - name: Build
      working-directory: ./IOT-Backend-main
      run: go build -v ./cmd/iot

  # Frontend Tests
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Cache Node modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      working-directory: ./IOT-Frontend-main/IOT-Frontend-main
      run: npm ci
    
    - name: Run tests
      working-directory: ./IOT-Frontend-main/IOT-Frontend-main
      run: npm test -- --watch=false --browsers=ChromeHeadless
    
    - name: Build
      working-directory: ./IOT-Frontend-main/IOT-Frontend-main
      run: npm run build -- --configuration production

  # Docker Build
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Backend Image
      uses: docker/build-push-action@v4
      with:
        context: ./IOT-Backend-main
        file: ./IOT-Backend-main/Dockerfile
        push: false
        tags: iot-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build Frontend Image
      uses: docker/build-push-action@v4
      with:
        context: ./IOT-Frontend-main/IOT-Frontend-main
        file: ./IOT-Frontend-main/IOT-Frontend-main/Dockerfile
        push: false
        tags: iot-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ESP32 Firmware Build
  firmware-build:
    name: Firmware Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Cache PlatformIO
      uses: actions/cache@v3
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-pio
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Build Coordinator Firmware
      working-directory: ./coordinator
      run: pio run
    
    - name: Build Node Firmware
      working-directory: ./node
      run: pio run
    
    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: firmware
        path: |
          coordinator/.pio/build/**/firmware.bin
          node/.pio/build/**/firmware.bin

  # Integration Tests (if docker-compose test exists)
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [docker-build]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Start services
      run: |
        cat > .env << EOF
        MONGO_ROOT_USER=admin
        MONGO_ROOT_PASSWORD=admin123
        MONGO_DB=iot_smarttile
        HTTP_ADDR=:8000
        MQTT_BROKER=tcp://mosquitto:1883
        MQTT_USERNAME=user1
        MQTT_PASSWORD=user1
        MONGO_URI=mongodb://admin:admin123@mongodb:27017
        GOOGLE_HOME_ENABLED=false
        EOF
        docker-compose up -d
    
    - name: Wait for services
      run: |
        echo "Waiting for services to be ready..."
        sleep 30
    
    - name: Check service health
      run: |
        curl -f http://localhost:8000/health || echo "Backend health check"
        curl -f http://localhost:4200/ || echo "Frontend check"
      continue-on-error: true
    
    - name: View logs on failure
      if: failure()
      run: docker-compose logs
    
    - name: Stop services
      if: always()
      run: docker-compose down -v
