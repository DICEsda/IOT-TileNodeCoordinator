@startuml IOT Smart Tile System Architecture

skinparam componentStyle rectangle
skinparam backgroundColor #FEFEFE
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 80

skinparam component {
    BackgroundColor<<coordinator>> #FFE4B5
    BackgroundColor<<node>> #B0E0E6
    BackgroundColor<<backend>> #90EE90
    BackgroundColor<<frontend>> #FFB6C1
    BackgroundColor<<infrastructure>> #E6E6FA
}

' Frontend Layer (Top)
package "Angular Frontend" <<frontend>> {
    component [Web Dashboard\n---\nPort 4200\nLive Telemetry\nZone Control\nNode Management\nmmWave Visualization] as Frontend
}

' Backend Layer
package "Go Backend API" <<backend>> {
    component [REST API\n---\n/api/sites\n/api/coordinators\n/api/nodes\n/health] as RestAPI
    component [WebSocket Server\n---\n/ws] as WebSocket
    component [MQTT Client\n---\nSubscribe: site/#\nPublish: Commands] as MqttClient
}

' Infrastructure Layer
package "Infrastructure" <<infrastructure>> {
    component [Mosquitto Broker\n---\nPort: 1883\nCredentials: user1/user1] as Mosquitto
    database [MongoDB\n---\nPort: 27017\nDatabase: iot_smarttile] as MongoDB
}

' Hardware Layer - Multiple Coordinator Groups
together {
    ' Coordinator 1 with its nodes
    package "Coordinator Group 1" {
        package "ESP32-S3 Coordinator 1" <<coordinator>> {
            component [Coord 1\n---\nManagers:\nESP-NOW, MQTT\nWiFi, NodeRegistry\nZone, Thermal] as Coord1
            component [Sensors\n---\nLight (ADC)\nTSL2561\nLD2450 mmWave\nNeoPixel LEDs] as Sensor1
            Coord1 -- Sensor1
        }
        
        package "Nodes (Coord 1)" <<node>> {
            component [Node 1.1\n---\nRGBW LEDs\nTMP117] as Node11
            component [Node 1.2\n---\nRGBW LEDs\nTMP117] as Node12
            component [Node 1.N\n---\nRGBW LEDs\nTMP117] as Node1N
            Node11 -[hidden]right- Node12
            Node12 -[hidden]right- Node1N
        }
    }
    
    ' Coordinator 2 with its nodes
    package "Coordinator Group 2" {
        package "ESP32-S3 Coordinator 2" <<coordinator>> {
            component [Coord 2\n---\nManagers:\nESP-NOW, MQTT\nWiFi, NodeRegistry\nZone, Thermal] as Coord2
            component [Sensors\n---\nLight (ADC)\nTSL2561\nLD2450 mmWave\nNeoPixel LEDs] as Sensor2
            Coord2 -- Sensor2
        }
        
        package "Nodes (Coord 2)" <<node>> {
            component [Node 2.1\n---\nRGBW LEDs\nTMP117] as Node21
            component [Node 2.2\n---\nRGBW LEDs\nTMP117] as Node22
            component [Node 2.N\n---\nRGBW LEDs\nTMP117] as Node2N
            Node21 -[hidden]right- Node22
            Node22 -[hidden]right- Node2N
        }
    }
    
    ' Coordinator M with its nodes
    package "Coordinator Group M" {
        package "ESP32-S3 Coordinator M" <<coordinator>> {
            component [Coord M\n---\nManagers:\nESP-NOW, MQTT\nWiFi, NodeRegistry\nZone, Thermal] as CoordM
            component [Sensors\n---\nLight (ADC)\nTSL2561\nLD2450 mmWave\nNeoPixel LEDs] as SensorM
            CoordM -- SensorM
        }
        
        package "Nodes (Coord M)" <<node>> {
            component [Node M.1\n---\nRGBW LEDs\nTMP117] as NodeM1
            component [Node M.2\n---\nRGBW LEDs\nTMP117] as NodeM2
            component [Node M.N\n---\nRGBW LEDs\nTMP117] as NodeMN
            NodeM1 -[hidden]right- NodeM2
            NodeM2 -[hidden]right- NodeMN
        }
    }
}

' ESP-NOW Communication (Nodes to Coordinators)
Node11 -up-> Coord1 : ESP-NOW
Node12 -up-> Coord1 : ESP-NOW
Node1N -up-> Coord1 : ESP-NOW

Node21 -up-> Coord2 : ESP-NOW
Node22 -up-> Coord2 : ESP-NOW
Node2N -up-> Coord2 : ESP-NOW

NodeM1 -up-> CoordM : ESP-NOW
NodeM2 -up-> CoordM : ESP-NOW
NodeMN -up-> CoordM : ESP-NOW

' WiFi/MQTT Communication (All Coordinators to Broker)
Coord1 -up-> Mosquitto : MQTT/WiFi\nsite/{siteId}/coord/1/...
Coord2 -up-> Mosquitto : MQTT/WiFi\nsite/{siteId}/coord/2/...
CoordM -up-> Mosquitto : MQTT/WiFi\nsite/{siteId}/coord/M/...

' Backend to Infrastructure
Mosquitto -left-> MqttClient : Subscribe\nsite/#
MqttClient -right-> Mosquitto : Publish\nCommands
MqttClient -down-> MongoDB : Store\nTelemetry
RestAPI -down-> MongoDB : Query\nData

' Backend to Frontend
WebSocket -up-> Frontend : Real-time\nWebSocket
RestAPI -up-> Frontend : HTTP\nREST

' Notes
note right of Coord1
  **Each Coordinator:**
  - Manages N nodes via ESP-NOW
  - Publishes to MQTT broker
  - Independent WiFi connection
  - Site/Zone configuration
  - Local sensor data
end note

note left of Node11
  **Node Telemetry:**
  - RGBW LED states
  - Temperature (TMP117)
  - Button events
  - Battery voltage
  - RSSI signal strength
end note

note top of Mosquitto
  **MQTT Topic Hierarchy:**
  
  Per Coordinator:
  • site/{siteId}/coord/{coordId}/telemetry
  • site/{siteId}/coord/{coordId}/mmwave
  • site/{siteId}/coord/{coordId}/status
  • site/{siteId}/coord/{coordId}/cmd
  
  Per Node (via Coordinator):
  • site/{siteId}/node/{nodeId}/telemetry
  • site/{siteId}/node/{nodeId}/cmd
end note

note bottom of MongoDB
  **MongoDB Collections:**
  - sites (1 per deployment)
  - coordinators (M per site)
  - nodes (N per coordinator)
  - telemetry_history
  - zones
  - commands_log
  - events
end note

' Legend
legend bottom left
  |= Color |= Component Type |
  | <<coordinator>> | ESP32-S3 Coordinators (M instances) |
  | <<node>> | ESP32-C3 Nodes (N per coordinator) |
  | <<backend>> | Go Backend Services |
  | <<frontend>> | Angular Web Dashboard |
  | <<infrastructure>> | MQTT Broker & Database |
  
  **Architecture:**
  • M Coordinators per Site
  • N Nodes per Coordinator
  • Each Coordinator = Independent ESP-NOW mesh
  • All Coordinators → Same MQTT Broker
  • Centralized Backend & Frontend
endlegend

@enduml
