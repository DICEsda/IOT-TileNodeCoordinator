@startuml IOT Smart Tile System Architecture

skinparam componentStyle rectangle
skinparam backgroundColor #FEFEFE
skinparam linetype ortho
skinparam nodesep 60
skinparam ranksep 60

skinparam component {
    BackgroundColor<<coordinator>> #FFE4B5
    BackgroundColor<<node>> #B0E0E6
    BackgroundColor<<backend>> #90EE90
    BackgroundColor<<frontend>> #FFB6C1
    BackgroundColor<<infrastructure>> #E6E6FA
}

' Frontend Layer (Top)
package "Angular Frontend" <<frontend>> {
    component [Web Dashboard\n---\nPort 4200\nLive Telemetry\nZone Control\nNode Management\nmmWave Visualization] as Frontend
}

' Backend Layer
package "Go Backend API" <<backend>> {
    component [REST API\n---\n/api/sites\n/api/coordinators\n/api/nodes\n/health] as RestAPI
    component [WebSocket Server\n---\n/ws] as WebSocket
    component [MQTT Client\n---\nSubscribe: site/#\nPublish: Commands] as MqttClient
}

' Infrastructure Layer
package "Infrastructure" <<infrastructure>> {
    component [Mosquitto Broker\n---\nPort: 1883\nCredentials: user1/user1] as Mosquitto
    database [MongoDB\n---\nPort: 27017\nDatabase: iot_smarttile] as MongoDB
}

' Hardware Layer - Zone 1 (Coordinator 1)
package "Zone 1" {
    package "ESP32-S3 Coordinator 1" <<coordinator>> {
        component [Coordinator 1\n---\nManagers:\n• ESP-NOW\n• MQTT\n• WiFi\n• NodeRegistry\n• ZoneControl\n• ThermalControl] as Coord1
        component [Sensors\n---\n• Ambient Light (ADC)\n• TSL2561 Light\n• LD2450 mmWave\n• NeoPixel LEDs] as Sensor1
        Coord1 -- Sensor1
    }
    
    package "Nodes (Zone 1)" <<node>> {
        component [Node 1.1\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as Node11
        component [Node 1.2\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as Node12
        component [Node 1.3\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as Node13
        component [Node 1.N\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as Node1N
        Node11 -[hidden]right- Node12
        Node12 -[hidden]right- Node13
        Node13 -[hidden]right- Node1N
    }
}

' Hardware Layer - Zone N (Coordinator N)
package "Zone N" {
    package "ESP32-S3 Coordinator N" <<coordinator>> {
        component [Coordinator N\n---\nManagers:\n• ESP-NOW\n• MQTT\n• WiFi\n• NodeRegistry\n• ZoneControl\n• ThermalControl] as CoordN
        component [Sensors\n---\n• Ambient Light (ADC)\n• TSL2561 Light\n• LD2450 mmWave\n• NeoPixel LEDs] as SensorN
        CoordN -- SensorN
    }
    
    package "Nodes (Zone N)" <<node>> {
        component [Node N.1\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as NodeN1
        component [Node N.2\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as NodeN2
        component [Node N.3\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as NodeN3
        component [Node N.N\n---\nRGBW LEDs\nTMP117 Temp\nButton\nBattery] as NodeNN
        NodeN1 -[hidden]right- NodeN2
        NodeN2 -[hidden]right- NodeN3
        NodeN3 -[hidden]right- NodeNN
    }
}

' ESP-NOW Communication (Nodes to Coordinators within Zone)
Node11 -up-> Coord1 : ESP-NOW
Node12 -up-> Coord1 : ESP-NOW
Node13 -up-> Coord1 : ESP-NOW
Node1N -up-> Coord1 : ESP-NOW

NodeN1 -up-> CoordN : ESP-NOW
NodeN2 -up-> CoordN : ESP-NOW
NodeN3 -up-> CoordN : ESP-NOW
NodeNN -up-> CoordN : ESP-NOW

' WiFi/MQTT Communication (Coordinators to Broker)
Coord1 -up-> Mosquitto : MQTT/WiFi\nsite/{siteId}/coord/1/...\nsite/{siteId}/node/{nodeId}/...
CoordN -up-> Mosquitto : MQTT/WiFi\nsite/{siteId}/coord/N/...\nsite/{siteId}/node/{nodeId}/...

' Backend to Infrastructure
Mosquitto -left-> MqttClient : Subscribe\nsite/#
MqttClient -right-> Mosquitto : Publish\nCommands
MqttClient -down-> MongoDB : Store\nTelemetry
RestAPI -down-> MongoDB : Query\nData

' Backend to Frontend
WebSocket -up-> Frontend : Real-time\nWebSocket
RestAPI -up-> Frontend : HTTP\nREST

' Notes
note right of Coord1
  **Zone 1 (Coordinator 1):**
  - Manages N nodes via ESP-NOW
  - Independent WiFi connection
  - Publishes to MQTT broker
  - Local sensor data
  - Zone configuration
end note

note left of CoordN
  **Zone N (Coordinator N):**
  - Manages N nodes via ESP-NOW
  - Independent WiFi connection
  - Publishes to MQTT broker
  - Local sensor data
  - Zone configuration
end note

note left of Node11
  **Node Features:**
  - RGBW LED control (PWM)
  - TMP117 Temperature (±0.1°C)
  - Button input (debounced)
  - Battery voltage monitoring
  - RSSI signal strength
  - Deep sleep capability
end note

note top of Mosquitto
  **MQTT Topic Hierarchy:**
  
  Coordinator 1:
  • site/{siteId}/coord/1/telemetry
  • site/{siteId}/coord/1/mmwave
  • site/{siteId}/coord/1/status
  • site/{siteId}/coord/1/cmd
  
  Coordinator N:
  • site/{siteId}/coord/N/telemetry
  • site/{siteId}/coord/N/mmwave
  • site/{siteId}/coord/N/status
  • site/{siteId}/coord/N/cmd
  
  Nodes (via Coordinators):
  • site/{siteId}/node/{nodeId}/telemetry
  • site/{siteId}/node/{nodeId}/cmd
end note

note bottom of MongoDB
  **MongoDB Collections:**
  - sites (1 per deployment)
  - coordinators (2: Zone 1 & Zone N)
  - nodes (N per coordinator)
  - telemetry_history (time-series)
  - zones (zone definitions)
  - commands_log (audit trail)
  - events (system events)
  - mmwave_events (presence detection)
end note

' Legend
legend bottom left
  |= Color |= Component Type |
  | <<coordinator>> | ESP32-S3 Coordinators (2 zones) |
  | <<node>> | ESP32-C3 Nodes (N per zone) |
  | <<backend>> | Go Backend Services |
  | <<frontend>> | Angular Web Dashboard |
  | <<infrastructure>> | MQTT Broker & Database |
  
  **Architecture Overview:**
  • 2 Coordinators (Zone 1 & Zone N)
  • N Nodes per Coordinator/Zone
  • Each Coordinator = Independent ESP-NOW mesh
  • Both Coordinators → Same MQTT Broker
  • Centralized Backend & Frontend
  • 1 Site with 2 Zones
endlegend

@enduml
