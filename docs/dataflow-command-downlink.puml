@startuml Command Downlink Flow

!theme plain
skinparam sequenceMessageAlign center
skinparam backgroundColor #FEFEFE

title Command Downlink Flow (Target Specific Coordinator)

actor User
participant "Angular\nFrontend" as Frontend
participant "Go Backend\nREST API" as Backend
participant "MongoDB" as DB
participant "Mosquitto\nMQTT Broker" as MQTT
participant "ESP32-S3\nCoordinator 1" as Coord1
participant "ESP32-C3\nNode 1.1" as Node11

note over User, Node11
  User selects a zone in Coordinator 1
  Commands are coordinator-specific
  Each coordinator manages its N nodes independently
end note

== User Initiates LED Command ==

User -> Frontend: Click "Set Zone 3 to Warm White"\n(Zone 3 is in Coordinator 1)
Frontend -> Frontend: Build command payload\n{\n  "cmd": "setLed",\n  "zoneId": "3",\n  "rgbw": {r:255, g:200, b:150, w:255}\n}

Frontend -> Backend: HTTP POST\n/api/sites/{siteId}/zones/3/cmd
activate Backend
Backend -> Backend: Validate command
Backend -> Backend: Lookup zone → Coordinator 1
Backend -> DB: Log command\n(audit trail)
Backend -> MQTT: Publish\nsite/{siteId}/coord/1/cmd\n{\n  "cmd": "setLed",\n  "zoneId": "3",\n  "rgbw": {...}\n}
deactivate Backend

== Coordinator Receives and Processes Command ==

MQTT -> Coord1: MQTT message\n{"cmd":"setLed",...}
activate Coord1
Coord1 -> Coord1: MqttManager\nparse command
Coord1 -> Coord1: ZoneControl\nresolve zone 3 → Nodes [1.1, 1.2, 1.3]
Coord1 -> Node11: ESP-NOW\nLightingCommand\n(RGBW values)
deactivate Coord1

note right of Coord1
  Coordinator sends ESP-NOW
  commands to all nodes in zone 3
end note

== Node Executes Command ==

Node11 -> Node11: Set RGBW LEDs\n(PWM channels)\nR=255, G=200, B=150, W=255
Node11 -> Node11: Read back LED state\n(verification)
Node11 -> Coord1: ESP-NOW Ack\nNodeStatus update\n(new RGBW values)

== Confirmation Flow ==

activate Coord1
Coord1 -> Coord1: Update NodeRegistry\ncache
Coord1 -> MQTT: Publish\nsite/{siteId}/node/1.1/telemetry\n(updated RGBW state)
deactivate Coord1

MQTT -> Backend: Confirmation
activate Backend
Backend -> DB: Update node state
Backend -> Frontend: WebSocket notification\n{\n  "event": "ledChanged",\n  "nodeId": "1.1",\n  "rgbw": {...}\n}
deactivate Backend

Frontend -> Frontend: Update UI\n- Zone card shows new color\n- Node status updated
Frontend -> User: Visual confirmation\n✓ Zone 3 updated

note right of Frontend
  UI reflects the change:
  • Zone color preview
  • Node status indicators
  • Real-time feedback
end note

@enduml
