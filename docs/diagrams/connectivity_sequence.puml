@startuml
title ESP-NOW Node <-> Coordinator and Coordinator <-> MQTT Broker

skinparam ParticipantPadding 10
skinparam BoxPadding 8
skinparam sequenceMessageAlign center

actor "Cloud App / Dashboard" as CloudApp
participant "MQTT Broker" as Broker
participant "Coordinator (ESP32)" as Coord
participant "Node (ESP32 Tile)" as Node

note over Node, Coord
ESP-NOW link:
- Peer-to-peer, MAC-addressed, optional PMK/LMK encryption
- Small payloads (<=250B), low-latency, retries on no-ACK
end note

== Bootstrapping ==
Coord -> Broker : MQTT CONNECT (clientId=coordinator-xyz, LWT: tiles/+/status = offline, retained)
Broker --> Coord : CONNACK
note right of Coord
Coordinator maintains Wi-Fi + MQTT, while ESP-NOW peers with nodes.
end note

== Telemetry uplink (ESP-NOW) ==
activate Node
Node -> Coord : ESP-NOW Unicast: Telemetry
note right of Coord
Telemetry payload (example):
{
  nodeId, tsUnix, seq,
  sensors: { tempC, humidity, accel, ... },
  batt_mV, rssi_at_node, fw_ver,
  health: { uptime_s, heap_free, err_flags }
}
end note
Coord --> Node : ESP-NOW Ack { seq, status: ok, opt: timeSync }
deactivate Node

opt Missing ACK / retry
Node -> Coord : ESP-NOW Retransmit (up to N attempts, backoff)
end

== MQTT publish ==
activate Coord
Coord -> Broker : MQTT PUBLISH "tiles/{nodeId}/telemetry" (QoS 1)
note right of Broker
Example JSON:
{
  coordTime: now,
  nodeId, seq,
  sensors: { tempC, humidity, accel },
  batt_mV, rssi_at_coord,
  link: { espnow_rssi, retries },
  fw: { node: "1.2.3", coord: "2.0.0" }
}
Retained=false
end note
Coord -> Broker : MQTT PUBLISH "tiles/{nodeId}/heartbeat" (QoS 0, periodic)
note right of Broker
Heartbeat: { nodeId, tsUnix, uptime_s, batt_mV, rssi, heap_free }
end note
deactivate Coord

== Online status ==
Coord -> Broker : MQTT PUBLISH "tiles/{nodeId}/status" = "online" (retained)
... later if disconnect ...
Broker -> CloudApp : LWT: "tiles/{nodeId}/status" = "offline" (retained)

== Downlink command (cloud -> node) ==
CloudApp -> Broker : MQTT PUBLISH "tiles/{nodeId}/cmd" (QoS 1)
note right of Broker
Cmd payload:
{ cmd_id, type, params, timeout_ms }
Examples:
- set_interval: { seconds }
- led: { mode, color, duration_ms }
- reboot: {}
- ota: { url, sha256 }
- calib: { axis, value }
end note
Broker -> Coord : MQTT DELIVER "tiles/{nodeId}/cmd"
Coord -> Node : ESP-NOW Unicast: Command { cmd_id, type, params }
Node --> Coord : ESP-NOW Ack/Result { cmd_id, result: ok|err, detail }
Coord -> Broker : MQTT PUBLISH "tiles/{nodeId}/cmd_result" { cmd_id, result, detail }

== Pairing / enrollment ==
opt Coordinator advertising (beacon)
Coord -> Node : ESP-NOW Beacon { coord_mac, channel, pairing_open }
end

Node -> Coord : ESP-NOW PairingRequest { deviceId|nodeId?, hw_mac, caps, fw_ver, node_nonce }

alt Enrollment open AND allowlist/new
Coord -> Node : ESP-NOW PairingChallenge { coord_nonce, ciphers:[pmk|lmk], time_s, window_s }
Node -> Coord : ESP-NOW PairingResponse { node_nonce, coord_nonce, proof(HMAC|sig), lmk_req:true }
note right of Coord
Proof covers both nonces and optional deviceId.
Coordinator will set PMK (global) and per-peer LMK for encryption.
end note
Coord -> Coord : esp_now_add_peer(node_mac, lmk)
Coord -> Node : ESP-NOW PairingAccept { paired:true, lmk_set:true, coord_mac, channel }
Coord -> Broker : MQTT PUBLISH "tiles/{nodeId}/enrolled" { hw_mac, caps, fw_ver }
else Enrollment closed / denied
Coord -> Node : ESP-NOW PairingReject { reason: closed|not_allowed }
end

opt Time sync after pairing
Coord -> Node : ESP-NOW TimeSync { tsUnix, drift_ppm }
Node --> Coord : ESP-NOW Ack { paired:true, timeSynced:true }
end

note over Node, Coord
Key fields:
- deviceId/nodeId, hw_mac, caps, fw_ver
- node_nonce, coord_nonce, proof(HMAC|sig)
- lmk_set, channel, coord_mac
end note

== Error paths ==
Node -> Coord : ESP-NOW Telemetry (corrupt/unknown)
Coord -> Broker : MQTT PUBLISH "tiles/{nodeId}/error" { seq, reason }
note over Coord
Coordinator may buffer and batch telemetry if MQTT is down:
- Queue with TTL and max depth
- Back-pressure to nodes via temp NACK
end note

legend left
Topics:
- tiles/{nodeId}/telemetry: JSON telemetry (QoS1, no retain)
- tiles/{nodeId}/heartbeat: lightweight health (QoS0)
- tiles/{nodeId}/status: "online"/"offline" (retained, LWT for offline)
- tiles/{nodeId}/cmd: downlink command from cloud (QoS1)
- tiles/{nodeId}/cmd_result: command result (QoS1)
- tiles/{nodeId}/error: parse/link errors
ESP-NOW payloads:
- Telemetry, Heartbeat, Ack, Command, Pairing
Key fields:
- nodeId, tsUnix, seq, batt_mV, rssi, sensors{...}, fw_ver, uptime_s
endlegend

@enduml
